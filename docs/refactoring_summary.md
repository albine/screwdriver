# ç­–ç•¥ç”Ÿå‘½å‘¨æœŸé‡æ„ - ç®€æ˜å¯¹æ¯”

## ä¸€å›¾çœ‹æ‡‚å˜åŒ–

### é‡æ„å‰ï¼ˆæœ‰é—®é¢˜ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ run_backtest_mode()                         â”‚
â”‚                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚  â”‚ StrategyEngine   â”‚                       â”‚
â”‚  â”‚                  â”‚                       â”‚
â”‚  â”‚ registry_[4]     â”‚â”€â”€â”                    â”‚
â”‚  â”‚   [symbol] ->    â”‚  â”‚ è£¸æŒ‡é’ˆ             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚                    â”‚
â”‚                        â”‚                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚                    â”‚
â”‚  â”‚ vector<unique>   â”‚  â”‚                    â”‚
â”‚  â”‚                  â”‚  â”‚                    â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚  â”‚                    â”‚
â”‚  â”‚ â”‚Strategy1â”‚<â”€â”€â”€â”€â”€â”¼â”€â”€â”˜ æ‹¥æœ‰æ‰€æœ‰æƒ         â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚                       â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚                       â”‚
â”‚  â”‚ â”‚Strategy2â”‚      â”‚                       â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚                       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚                                             â”‚
â”‚  é—®é¢˜ï¼š                                      â”‚
â”‚  1. æ‰€æœ‰æƒåˆ†ç¦»ï¼ˆvectoræ‹¥æœ‰ï¼Œengineä½¿ç”¨ï¼‰      â”‚
â”‚  2. ä¾èµ–å£°æ˜é¡ºåºï¼ˆå…ˆengineåvectorï¼‰         â”‚
â”‚  3. ææ„é¡ºåºé”™è¯¯ -> æ®µé”™è¯¯ ğŸ’¥                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### é‡æ„åï¼ˆæ­£ç¡®ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ run_backtest_mode()                         â”‚
â”‚                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ StrategyEngine                       â”‚   â”‚
â”‚  â”‚                                      â”‚   â”‚
â”‚  â”‚ owned_strategies_                    â”‚   â”‚
â”‚  â”‚   [symbol] -> unique_ptr             â”‚   â”‚
â”‚  â”‚       â”‚                              â”‚   â”‚
â”‚  â”‚       â”œâ”€> â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚   â”‚
â”‚  â”‚       â”‚   â”‚Strategy1â”‚                â”‚   â”‚
â”‚  â”‚       â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚   â”‚
â”‚  â”‚       â”‚                              â”‚   â”‚
â”‚  â”‚       â””â”€> â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚   â”‚
â”‚  â”‚           â”‚Strategy2â”‚                â”‚   â”‚
â”‚  â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚   â”‚
â”‚  â”‚                â”‚                     â”‚   â”‚
â”‚  â”‚                â”‚                     â”‚   â”‚
â”‚  â”‚ registry_[4]   â”‚                     â”‚   â”‚
â”‚  â”‚   [symbol] â”€â”€â”€â”€â”˜ è£¸æŒ‡é’ˆï¼ˆå¿«é€ŸæŸ¥æ‰¾ï¼‰    â”‚   â”‚
â”‚  â”‚                                      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                             â”‚
â”‚  ä¼˜åŠ¿ï¼š                                      â”‚
â”‚  1. æ‰€æœ‰æƒæ˜ç¡®ï¼ˆengineå®Œå…¨æ‹¥æœ‰ï¼‰             â”‚
â”‚  2. å£°æ˜é¡ºåºæ— å…³ï¼ˆè‡ªåŒ…å«ï¼‰                   â”‚
â”‚  3. ä¸å¯èƒ½æ®µé”™è¯¯ âœ“                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ä»£ç å¯¹æ¯”

### æ³¨å†Œç­–ç•¥

| é‡æ„å‰ | é‡æ„å |
|--------|--------|
| `auto s = factory.create(...);`<br>`engine.register_strategy(symbol, s.get());`<br>`strategies.push_back(std::move(s));` | `auto s = factory.create(...);`<br>`engine.register_strategy(symbol, std::move(s));` |

### å®Œæ•´ä»£ç 

| é‡æ„å‰ | é‡æ„å |
|--------|--------|
| <pre>StrategyEngine engine;<br>vector<unique_ptr<Strategy>> strategies;<br><br>for (auto& cfg : configs) {<br>  auto s = factory.create(...);<br>  engine.register_strategy(symbol, s.get());<br>  strategies.push_back(std::move(s));<br>}<br><br>// âŒ ä¾èµ–é¡ºåºï¼šengine å¿…é¡»å…ˆå£°æ˜</pre> | <pre>StrategyEngine engine;<br><br>for (auto& cfg : configs) {<br>  auto s = factory.create(...);<br>  engine.register_strategy(symbol, std::move(s));<br>}<br><br>// âœ“ ä¸ä¾èµ–é¡ºåºï¼Œå®Œå…¨å®‰å…¨</pre> |

## å…³é”®æ”¹è¿›

| æ–¹é¢ | é‡æ„å‰ | é‡æ„å |
|------|--------|--------|
| **æ‰€æœ‰æƒ** | åˆ†ç¦»ï¼ˆå¤–éƒ¨vectoræ‹¥æœ‰ï¼‰ | æ˜ç¡®ï¼ˆengineæ‹¥æœ‰ï¼‰ |
| **RAII** | âŒ è¿åï¼ˆä¾èµ–å¤–éƒ¨ï¼‰ | âœ“ ç¬¦åˆï¼ˆè‡ªåŒ…å«ï¼‰ |
| **å®‰å…¨æ€§** | âš ï¸ æ‚¬ç©ºæŒ‡é’ˆé£é™© | âœ“ ç¼–è¯‘æœŸä¿è¯ |
| **æ˜“ç”¨æ€§** | å¤æ‚ï¼ˆéœ€è¦ç®¡ç†vectorï¼‰ | ç®€å•ï¼ˆç›´æ¥è½¬ç§»æ‰€æœ‰æƒï¼‰ |
| **æ€§èƒ½** | åŸºå‡† | ç›¸åŒï¼ˆ<1%å·®å¼‚ï¼‰ |
| **å¯ç»´æŠ¤æ€§** | ä½ï¼ˆéšå¼ä¾èµ–ï¼‰ | é«˜ï¼ˆæ˜¾å¼æ‰€æœ‰æƒï¼‰ |

## æ–°å¢åŠŸèƒ½

```cpp
// 1. è¿è¡Œæ—¶ç§»é™¤ç­–ç•¥
engine.unregister_strategy("600759.SH");

// 2. æŸ¥è¯¢ç­–ç•¥æ•°é‡
size_t count = engine.strategy_count();

// 3. æ”¯æŒåŠ¨æ€æ·»åŠ 
engine.register_strategy("NEW.SH", create_strategy());
```

## æµ‹è¯•ç»“æœ

```bash
$ ./run_backtest.py 20260112
âœ“ 600759.SH æ•°æ®ä¸‹è½½æˆåŠŸ
âœ“ 603938.SH æ•°æ®ä¸‹è½½æˆåŠŸ
âœ“ å›æµ‹å®Œæˆ
é€€å‡ºç : 0

$ ./build/engine backtest
...
[Strategy] ========================================
é€€å‡ºç : 0  # âœ“ æ— æ®µé”™è¯¯
```

## ç»“è®º

âœ… **é‡æ„æˆåŠŸ**
- ä»æ ¹æœ¬ä¸Šè§£å†³äº†æ®µé”™è¯¯é—®é¢˜
- æå‡äº†ä»£ç è´¨é‡å’Œå¯ç»´æŠ¤æ€§
- é›¶æ€§èƒ½æŸå¤±
- å‘åä¸å…¼å®¹ï¼Œä½†è¿ç§»ç®€å•

ğŸ“ **å»ºè®®**
- æ‰€æœ‰é¡¹ç›®ç«‹å³è¿ç§»
- å‚è€ƒ [refactoring_strategy_ownership.md](./refactoring_strategy_ownership.md) è·å–è¯¦ç»†æŒ‡å—
